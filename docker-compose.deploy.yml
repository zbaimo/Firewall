# ===================================================================
# Nginxæ™ºèƒ½é˜²ç«å¢™ç³»ç»Ÿ - ç”Ÿäº§éƒ¨ç½²é…ç½®
# Version: 1.2.0
# åŸºäºiptablesçš„å¢å¼ºå‹é˜²ç«å¢™ç³»ç»Ÿ
# ===================================================================

services:
  # ===================================================================
  # é˜²ç«å¢™ä¸»æœåŠ¡
  # ===================================================================
  firewall:
    # Docker Hubé•œåƒ
    image: zbaimo/nginx-firewall:latest
    
    # å®¹å™¨é…ç½®
    container_name: nginx-firewall
    restart: always
    hostname: nginx-firewall
    
    # ===================================================================
    # ç½‘ç»œæ¨¡å¼ï¼šä¸»æœºç½‘ç»œï¼ˆå¿…éœ€ï¼Œç”¨äºiptablesæ“ä½œï¼‰
    # ===================================================================
    network_mode: "host"
    
    # è¯´æ˜ï¼š
    # - å®¹å™¨ä½¿ç”¨ä¸»æœºç½‘ç»œæ ˆ
    # - å¯ä»¥ç›´æ¥æ“ä½œä¸»æœºiptables
    # - æœåŠ¡ç›‘å¬ç«¯å£ï¼š8080ï¼ˆå¯åœ¨config.yamlä¿®æ”¹ï¼‰
    # - Redisè¿æ¥ï¼šlocalhost:6379
    
    # ===================================================================
    # æ•°æ®å·æŒ‚è½½
    # ===================================================================
    volumes:
      # é…ç½®æ–‡ä»¶ï¼ˆåªè¯»ï¼‰
      - ./config.yaml:/app/config.yaml:ro
      
      # Nginxæ—¥å¿—ç›®å½•ï¼ˆåªè¯»ï¼‰- âš ï¸ ä¿®æ”¹ä¸ºä½ çš„å®é™…è·¯å¾„
      - /root/data/Nginx:/var/log/nginx:ro
      # Windowsç¤ºä¾‹: - C:/nginx/logs:/var/log/nginx:ro
      # Linuxç¤ºä¾‹: - /var/log/nginx:/var/log/nginx:ro
      
      # æ•°æ®æŒä¹…åŒ–ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ç­‰ï¼‰
      - firewall-data:/data
      
      # æ—¥å¿—ç›®å½•ï¼ˆç³»ç»Ÿæ—¥å¿—ã€å®¡è®¡æ—¥å¿—ï¼‰
      - ./logs:/app/logs
      
      # å¯¼å‡ºæ–‡ä»¶ç›®å½•
      - ./exports:/app/exports
      
      # iptablesè§„åˆ™å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
      - ./iptables-backup:/etc/iptables
      
      # GeoIPæ•°æ®åº“ï¼ˆå¯é€‰ï¼Œå¦‚å¯ç”¨åœ°ç†ä½ç½®åŠŸèƒ½ï¼‰
      # ä¸‹è½½: https://dev.maxmind.com/geoip/geoip2/geolite2/
      # - ./GeoLite2-City.mmdb:/app/GeoLite2-City.mmdb:ro
    
    # ===================================================================
    # ç¯å¢ƒå˜é‡
    # ===================================================================
    environment:
      # æ—¶åŒº
      - TZ=Asia/Shanghai
      
      # Redisè¿æ¥ï¼ˆhostæ¨¡å¼ä½¿ç”¨localhostï¼‰
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      
      # è¿è¡Œæ¨¡å¼
      - ENVIRONMENT=production
      - PYTHONUNBUFFERED=1
      
      # å¯é€‰ï¼šé€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®
      # - FIREWALL_ENABLED=true
      # - GEO_ENABLED=true
      # - AUDIT_ENABLED=true
    
    # ===================================================================
    # æƒé™é…ç½®ï¼ˆiptablesæ“ä½œå¿…éœ€ï¼‰
    # ===================================================================
    
    # æ–¹å¼1ï¼šç‰¹æƒæ¨¡å¼ï¼ˆæ¨èï¼ŒåŠŸèƒ½æœ€å®Œæ•´ï¼‰
    privileged: true
    
    # æ–¹å¼2ï¼šèƒ½åŠ›æˆæƒï¼ˆæ›´å®‰å…¨ï¼Œä½†åŠŸèƒ½å¯èƒ½å—é™ï¼‰
    # privileged: false
    # cap_add:
    #   - NET_ADMIN
    #   - NET_RAW
    #   - SYS_MODULE
    
    # ===================================================================
    # èµ„æºé™åˆ¶
    # ===================================================================
    deploy:
      resources:
        limits:
          cpus: '2.0'          # æœ€å¤š2æ ¸CPU
          memory: 1G           # æœ€å¤š1GBå†…å­˜
        reservations:
          cpus: '0.5'          # é¢„ç•™0.5æ ¸
          memory: 256M         # é¢„ç•™256MB
    
    # ===================================================================
    # å¥åº·æ£€æŸ¥
    # ===================================================================
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/api/system/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # ===================================================================
    # æ—¥å¿—é…ç½®
    # ===================================================================
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    
    # ===================================================================
    # ä¾èµ–æœåŠ¡
    # ===================================================================
    depends_on:
      redis:
        condition: service_healthy

  # ===================================================================
  # Redisç¼“å­˜æœåŠ¡
  # ===================================================================
  redis:
    image: redis:7-alpine
    container_name: firewall-redis
    restart: always
    hostname: firewall-redis
    
    # ä½¿ç”¨ä¸»æœºç½‘ç»œï¼ˆä¸é˜²ç«å¢™æœåŠ¡é€šä¿¡ï¼‰
    network_mode: "host"
    
    # Redisä¼˜åŒ–é…ç½®
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --save 300 100
      --save 900 1
      --bind 127.0.0.1
      --protected-mode yes
      --tcp-backlog 511
      --timeout 300
      --tcp-keepalive 300
      --daemonize no
      --loglevel notice
    
    # æ•°æ®æŒä¹…åŒ–
    volumes:
      - redis-data:/data
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ===================================================================
# æ•°æ®å·
# ===================================================================
volumes:
  # é˜²ç«å¢™æ•°æ®ï¼ˆSQLiteæ•°æ®åº“ã€é…ç½®ç­‰ï¼‰
  firewall-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
  
  # Redisæ•°æ®ï¼ˆæŒä¹…åŒ–ï¼‰
  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./redis-data

# ===================================================================
# ä½¿ç”¨è¯´æ˜
# ===================================================================
#
# ğŸš€ å¿«é€Ÿå¯åŠ¨:
#   docker-compose -f docker-compose.deploy.yml up -d
#
# ğŸ“‹ æŸ¥çœ‹æ—¥å¿—:
#   docker-compose -f docker-compose.deploy.yml logs -f
#   docker-compose -f docker-compose.deploy.yml logs -f firewall
#   docker-compose -f docker-compose.deploy.yml logs -f redis
#
# ğŸ›‘ åœæ­¢æœåŠ¡:
#   docker-compose -f docker-compose.deploy.yml down
#
# ğŸ”„ æ›´æ–°é•œåƒ:
#   docker-compose -f docker-compose.deploy.yml pull
#   docker-compose -f docker-compose.deploy.yml up -d --force-recreate
#
# ğŸ“Š æŸ¥çœ‹çŠ¶æ€:
#   docker-compose -f docker-compose.deploy.yml ps
#   docker stats nginx-firewall firewall-redis
#
# ğŸ” è¿›å…¥å®¹å™¨:
#   docker exec -it nginx-firewall bash
#
# ğŸŒ Webè®¿é—®:
#   http://localhost:8080          # ä»ªè¡¨æ¿
#   http://localhost:8080/firewall # é˜²ç«å¢™ç®¡ç†
#   http://localhost:8080/rules    # è§„åˆ™ç®¡ç†
#   http://localhost:8080/ports    # ç«¯å£ç®¡ç†
#   http://localhost:8080/settings # è®¾ç½®
#
# ğŸ‘¤ é»˜è®¤ç™»å½•:
#   ç”¨æˆ·å: admin
#   å¯†ç : admin (é¦–æ¬¡ç™»å½•å¼ºåˆ¶ä¿®æ”¹)
#
# ğŸ› ï¸ CLIå·¥å…·ä½¿ç”¨:
#   docker exec nginx-firewall python tools/firewall_cli.py --help
#   docker exec nginx-firewall python tools/firewall_cli.py stats
#   docker exec nginx-firewall python tools/firewall_cli.py health
#
# ğŸ”¥ æŸ¥çœ‹iptablesè§„åˆ™:
#   docker exec nginx-firewall iptables -L FIREWALL_BANS -n -v
#   docker exec nginx-firewall iptables -L FIREWALL_RATE_LIMIT -n
#   docker exec nginx-firewall iptables -L FIREWALL_PORT_RULES -n
#
# ğŸ“¦ å¤‡ä»½:
#   tar czf backup_$(date +%Y%m%d).tar.gz data/ logs/ exports/ config.yaml
#
# âš™ï¸ é…ç½®ä¿®æ”¹:
#   ç¼–è¾‘ config.yaml åé‡å¯:
#   docker-compose -f docker-compose.deploy.yml restart firewall
#
# ===================================================================
# é‡è¦æç¤º
# ===================================================================
#
# âš ï¸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å¿…é¡»ä¿®æ”¹:
#   1. config.yaml ä¸­çš„ secret_key å’Œ password_salt
#   2. nginx.access_log æ”¹ä¸ºå®é™…çš„æ—¥å¿—è·¯å¾„
#   3. æœ¬æ–‡ä»¶ä¸­çš„ Nginxæ—¥å¿—å·æŒ‚è½½è·¯å¾„
#
# âš ï¸ é˜²ç«å¢™åŠŸèƒ½éœ€è¦:
#   1. privileged: true æˆ–åˆé€‚çš„ cap_add
#   2. network_mode: "host"
#   3. Linuxå†…æ ¸æ”¯æŒiptables
#
# âš ï¸ æ•°æ®æŒä¹…åŒ–:
#   data/ å’Œ redis-data/ ç›®å½•ä¼šè‡ªåŠ¨åˆ›å»º
#   å»ºè®®å®šæœŸå¤‡ä»½è¿™äº›ç›®å½•
#
# ===================================================================
