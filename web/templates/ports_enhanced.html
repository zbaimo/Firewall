<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á´ØÂè£ÁÆ°ÁêÜ - NginxÈò≤ÁÅ´Â¢ô</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            color: #333;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #718096;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .port-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .port-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .port-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .port-card.open {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .port-card.blocked {
            border-color: #f56565;
            background: #fff5f5;
        }
        
        .port-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .port-name {
            font-size: 13px;
            color: #718096;
            margin-bottom: 3px;
        }
        
        .port-protocol {
            font-size: 11px;
            color: #a0aec0;
        }
        
        .port-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .status-open {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-closed {
            background: #cbd5e0;
            color: #2d3748;
        }
        
        .status-blocked {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        
        .table tr:hover {
            background: #f7fafc;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .badge-warning {
            background: #feebc8;
            color: #7c2d12;
        }
        
        .badge-info {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .port-details {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 500;
            color: #4a5568;
        }
        
        .detail-value {
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîå Á´ØÂè£ÁÆ°ÁêÜ‰∏≠ÂøÉ</h1>
            <div>
                <a href="/" class="btn btn-secondary">ËøîÂõûÈ¶ñÈ°µ</a>
                <a href="/api/auth/logout" class="btn btn-danger">ÈÄÄÂá∫ÁôªÂΩï</a>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalPorts">0</div>
                <div class="stat-label">Â∏∏Áî®Á´ØÂè£</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="openPorts">0</div>
                <div class="stat-label">ÂºÄÊîæÁ´ØÂè£</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="blockedPorts">0</div>
                <div class="stat-label">ÈòªÊ≠¢Á´ØÂè£</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="customRules">0</div>
                <div class="stat-label">Ëá™ÂÆö‰πâËßÑÂàô</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('common')">Â∏∏Áî®Á´ØÂè£</div>
            <div class="tab" onclick="switchTab('custom')">Ëá™ÂÆö‰πâËßÑÂàô</div>
            <div class="tab" onclick="switchTab('scan')">Á´ØÂè£Êâ´Êèè</div>
            <div class="tab" onclick="switchTab('logs')">Êìç‰ΩúÊó•Âøó</div>
        </div>
        
        <!-- Â∏∏Áî®Á´ØÂè£Ê†áÁ≠æÈ°µ -->
        <div id="common-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Â∏∏Áî®Á´ØÂè£Âø´ÈÄüÁÆ°ÁêÜ</h2>
                    <div>
                        <button class="btn btn-success" onclick="batchOpen()">ÊâπÈáèÂºÄÊîæ</button>
                        <button class="btn btn-danger" onclick="batchBlock()">ÊâπÈáèÈòªÊ≠¢</button>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="ÊêúÁ¥¢Á´ØÂè£Âè∑ÊàñÊúçÂä°ÂêçÁß∞..." 
                           onkeyup="filterPorts()">
                    <span class="search-icon">üîç</span>
                </div>
                
                <div class="port-grid" id="commonPortsGrid"></div>
            </div>
        </div>
        
        <!-- Ëá™ÂÆö‰πâËßÑÂàôÊ†áÁ≠æÈ°µ -->
        <div id="custom-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Ëá™ÂÆö‰πâÁ´ØÂè£ËßÑÂàô</h2>
                    <button class="btn btn-primary" onclick="showAddCustomRule()">+ Ê∑ªÂä†ËßÑÂàô</button>
                </div>
                
                <table class="table" id="customRulesTable">
                    <thead>
                        <tr>
                            <th>Á´ØÂè£</th>
                            <th>ÂçèËÆÆ</th>
                            <th>Âä®‰Ωú</th>
                            <th>ÊèèËø∞</th>
                            <th>ÂàõÂª∫Êó∂Èó¥</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="customRulesBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Á´ØÂè£Êâ´ÊèèÊ†áÁ≠æÈ°µ -->
        <div id="scan-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Á´ØÂè£Êâ´ÊèèÊ£ÄÊµã</h2>
                    <button class="btn btn-primary" onclick="refreshScanData()">üîÑ Âà∑Êñ∞</button>
                </div>
                
                <p style="color: #718096; margin-bottom: 20px;">
                    Ê£ÄÊµãÂà∞ÁöÑÁ´ØÂè£Êâ´ÊèèË°å‰∏∫Â∞ÜÂú®ËøôÈáåÊòæÁ§∫
                </p>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>IPÂú∞ÂùÄ</th>
                            <th>Êâ´ÊèèÁ´ØÂè£Êï∞</th>
                            <th>Êó∂Èó¥ËåÉÂõ¥</th>
                            <th>Â®ÅËÉÅÁ≠âÁ∫ß</th>
                            <th>Áä∂ÊÄÅ</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="scanDetectionBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Êìç‰ΩúÊó•ÂøóÊ†áÁ≠æÈ°µ -->
        <div id="logs-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Á´ØÂè£Êìç‰ΩúÊó•Âøó</h2>
                    <button class="btn btn-secondary" onclick="exportLogs()">ÂØºÂá∫Êó•Âøó</button>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Êó∂Èó¥</th>
                            <th>Êìç‰Ωú</th>
                            <th>Á´ØÂè£</th>
                            <th>ÂçèËÆÆ</th>
                            <th>Êìç‰ΩúËÄÖ</th>
                            <th>ÁªìÊûú</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Ê∑ªÂä†Ëá™ÂÆö‰πâËßÑÂàôÊ®°ÊÄÅÊ°Ü -->
    <div id="customRuleModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Ê∑ªÂä†Ëá™ÂÆö‰πâÁ´ØÂè£ËßÑÂàô</h2>
            <form id="customRuleForm">
                <div class="form-group">
                    <label class="form-label">Á´ØÂè£Âè∑</label>
                    <input type="number" class="form-input" id="customPort" 
                           placeholder="1-65535" min="1" max="65535" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÂçèËÆÆ</label>
                    <select class="form-select" id="customProtocol" required>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="both">TCP + UDP</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Âä®‰Ωú</label>
                    <select class="form-select" id="customAction" required>
                        <option value="allow">ÂÖÅËÆ∏ÔºàÂºÄÊîæÔºâ</option>
                        <option value="deny">ÊãíÁªùÔºàÈòªÊ≠¢Ôºâ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÊèèËø∞</label>
                    <input type="text" class="form-input" id="customDescription" 
                           placeholder="‰æãÂ¶ÇÔºöËá™ÂÆö‰πâWebÊúçÂä°">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Êù•Ê∫êIPÔºàÂèØÈÄâÔºâ</label>
                    <input type="text" class="form-input" id="customSource" 
                           placeholder="ÁïôÁ©∫=ÊâÄÊúâIPÔºåÊàñËæìÂÖ•ÁâπÂÆöIP/CIDR">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeCustomModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">Ê∑ªÂä†ËßÑÂàô</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Á´ØÂè£ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div id="portDetailModal" class="modal">
        <div class="modal-content">
            <h2 id="portDetailTitle" style="margin-bottom: 20px;">Á´ØÂè£ËØ¶ÊÉÖ</h2>
            <div id="portDetailContent"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentTab = 'common';
        let commonPorts = [];
        let customRules = [];
        
        // Â∏∏Áî®Á´ØÂè£ÂàóË°®
        const wellKnownPorts = [
            {port: 20, name: 'FTPÊï∞ÊçÆ', protocol: 'tcp', category: 'file'},
            {port: 21, name: 'FTPÊéßÂà∂', protocol: 'tcp', category: 'file'},
            {port: 22, name: 'SSH', protocol: 'tcp', category: 'remote'},
            {port: 23, name: 'Telnet', protocol: 'tcp', category: 'remote'},
            {port: 25, name: 'SMTP', protocol: 'tcp', category: 'email'},
            {port: 53, name: 'DNS', protocol: 'both', category: 'dns'},
            {port: 80, name: 'HTTP', protocol: 'tcp', category: 'web'},
            {port: 110, name: 'POP3', protocol: 'tcp', category: 'email'},
            {port: 143, name: 'IMAP', protocol: 'tcp', category: 'email'},
            {port: 443, name: 'HTTPS', protocol: 'tcp', category: 'web'},
            {port: 465, name: 'SMTPS', protocol: 'tcp', category: 'email'},
            {port: 587, name: 'SMTPÊèê‰∫§', protocol: 'tcp', category: 'email'},
            {port: 993, name: 'IMAPS', protocol: 'tcp', category: 'email'},
            {port: 995, name: 'POP3S', protocol: 'tcp', category: 'email'},
            {port: 3306, name: 'MySQL', protocol: 'tcp', category: 'database'},
            {port: 3389, name: 'RDP', protocol: 'tcp', category: 'remote'},
            {port: 5432, name: 'PostgreSQL', protocol: 'tcp', category: 'database'},
            {port: 6379, name: 'Redis', protocol: 'tcp', category: 'database'},
            {port: 8080, name: 'HTTP‰ª£ÁêÜ', protocol: 'tcp', category: 'web'},
            {port: 8443, name: 'HTTPS Alt', protocol: 'tcp', category: 'web'},
            {port: 9000, name: 'PHP-FPM', protocol: 'tcp', category: 'web'},
            {port: 27017, name: 'MongoDB', protocol: 'tcp', category: 'database'}
        ];
        
        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
            
            if (tab === 'common') {
                loadCommonPorts();
            } else if (tab === 'custom') {
                loadCustomRules();
            } else if (tab === 'scan') {
                loadScanDetection();
            } else if (tab === 'logs') {
                loadLogs();
            }
        }
        
        // Âä†ËΩΩÂ∏∏Áî®Á´ØÂè£
        async function loadCommonPorts() {
            try {
                const response = await fetch('/api/ports/common');
                const data = await response.json();
                commonPorts = data.ports || [];
                
                renderCommonPorts();
                updateStats();
            } catch (error) {
                console.error('Âä†ËΩΩÂ∏∏Áî®Á´ØÂè£Â§±Ë¥•:', error);
            }
        }
        
        // Ê∏≤ÊüìÂ∏∏Áî®Á´ØÂè£
        function renderCommonPorts() {
            const grid = document.getElementById('commonPortsGrid');
            grid.innerHTML = wellKnownPorts.map(port => {
                const status = getPortStatus(port.port);
                const statusClass = status === 'open' ? 'open' : status === 'blocked' ? 'blocked' : '';
                const statusText = status === 'open' ? 'ÂºÄÊîæ' : status === 'blocked' ? 'ÈòªÊ≠¢' : 'ÂÖ≥Èó≠';
                const statusBadge = status === 'open' ? 'status-open' : status === 'blocked' ? 'status-blocked' : 'status-closed';
                
                return `
                    <div class="port-card ${statusClass}" onclick="showPortDetail(${port.port}, '${port.name}', '${port.protocol}')">
                        <div class="port-number">${port.port}</div>
                        <div class="port-name">${port.name}</div>
                        <div class="port-protocol">${port.protocol.toUpperCase()}</div>
                        <div class="port-status ${statusBadge}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Ëé∑ÂèñÁ´ØÂè£Áä∂ÊÄÅ
        function getPortStatus(port) {
            const rule = commonPorts.find(p => p.port === port);
            if (!rule) return 'closed';
            return rule.action === 'allow' ? 'open' : 'blocked';
        }
        
        // ÊòæÁ§∫Á´ØÂè£ËØ¶ÊÉÖ
        function showPortDetail(port, name, protocol) {
            const portInfo = wellKnownPorts.find(p => p.port === port);
            const status = getPortStatus(port);
            
            document.getElementById('portDetailTitle').textContent = `Á´ØÂè£ ${port} - ${name}`;
            document.getElementById('portDetailContent').innerHTML = `
                <div class="port-details">
                    <div class="detail-row">
                        <span class="detail-label">Á´ØÂè£Âè∑Ôºö</span>
                        <span class="detail-value">${port}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÊúçÂä°ÂêçÁß∞Ôºö</span>
                        <span class="detail-value">${name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÂçèËÆÆÔºö</span>
                        <span class="detail-value">${protocol.toUpperCase()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÂΩìÂâçÁä∂ÊÄÅÔºö</span>
                        <span class="detail-value">
                            <span class="badge ${status === 'open' ? 'badge-success' : status === 'blocked' ? 'badge-danger' : 'badge-info'}">
                                ${status === 'open' ? 'ÂºÄÊîæ' : status === 'blocked' ? 'ÈòªÊ≠¢' : 'ÂÖ≥Èó≠'}
                            </span>
                        </span>
                    </div>
                </div>
                <div class="action-buttons" style="margin-top: 20px;">
                    ${status !== 'open' ? `
                        <button class="btn btn-success" onclick="openPort(${port}, '${protocol}', '${name}')">
                            üîì ÂºÄÊîæÊ≠§Á´ØÂè£
                        </button>
                    ` : ''}
                    ${status === 'open' ? `
                        <button class="btn btn-warning" onclick="closePort(${port}, '${protocol}')">
                            üîí ÂÖ≥Èó≠Ê≠§Á´ØÂè£
                        </button>
                    ` : ''}
                    ${status !== 'blocked' ? `
                        <button class="btn btn-danger" onclick="blockPort(${port}, '${protocol}')">
                            üö´ ÈòªÊ≠¢Ê≠§Á´ØÂè£
                        </button>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('portDetailModal').classList.add('active');
        }
        
        function closeDetailModal() {
            document.getElementById('portDetailModal').classList.remove('active');
        }
        
        // Á´ØÂè£Êìç‰Ωú
        async function openPort(port, protocol, name) {
            try {
                const response = await fetch('/api/ports/open', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({port, protocol, description: name})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Á´ØÂè£Â∑≤ÂºÄÊîæÔºÅ');
                    closeDetailModal();
                    loadCommonPorts();
                } else {
                    alert('Êìç‰ΩúÂ§±Ë¥•Ôºö' + data.message);
                }
            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•Ôºö' + error.message);
            }
        }
        
        async function closePort(port, protocol) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂÖ≥Èó≠Á´ØÂè£ ${port}/${protocol} ÂêóÔºü`)) return;
            
            try {
                const response = await fetch('/api/ports/close', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({port, protocol})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Á´ØÂè£Â∑≤ÂÖ≥Èó≠ÔºÅ');
                    closeDetailModal();
                    loadCommonPorts();
                } else {
                    alert('Êìç‰ΩúÂ§±Ë¥•Ôºö' + data.message);
                }
            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•Ôºö' + error.message);
            }
        }
        
        async function blockPort(port, protocol) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÈòªÊ≠¢Á´ØÂè£ ${port}/${protocol} ÂêóÔºü`)) return;
            
            try {
                const response = await fetch('/api/ports/block', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({port, protocol})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Á´ØÂè£Â∑≤ÈòªÊ≠¢ÔºÅ');
                    closeDetailModal();
                    loadCommonPorts();
                } else {
                    alert('Êìç‰ΩúÂ§±Ë¥•Ôºö' + data.message);
                }
            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // Âä†ËΩΩËá™ÂÆö‰πâËßÑÂàô
        async function loadCustomRules() {
            try {
                const response = await fetch('/api/ports');
                const data = await response.json();
                customRules = data.ports || [];
                
                const tbody = document.getElementById('customRulesBody');
                tbody.innerHTML = customRules.map(rule => `
                    <tr>
                        <td><strong>${rule.port}</strong></td>
                        <td>${rule.protocol.toUpperCase()}</td>
                        <td>
                            <span class="badge ${rule.action === 'allow' ? 'badge-success' : 'badge-danger'}">
                                ${rule.action === 'allow' ? 'ÂÖÅËÆ∏' : 'ÊãíÁªù'}
                            </span>
                        </td>
                        <td>${rule.description || '-'}</td>
                        <td>${new Date(rule.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 5px 10px;" 
                                    onclick="deleteRule(${rule.id})">Âà†Èô§</button>
                        </td>
                    </tr>
                `).join('');
                
                updateStats();
            } catch (error) {
                console.error('Âä†ËΩΩËá™ÂÆö‰πâËßÑÂàôÂ§±Ë¥•:', error);
            }
        }
        
        // Ëá™ÂÆö‰πâËßÑÂàôÁõ∏ÂÖ≥
        function showAddCustomRule() {
            document.getElementById('customRuleModal').classList.add('active');
        }
        
        function closeCustomModal() {
            document.getElementById('customRuleModal').classList.remove('active');
            document.getElementById('customRuleForm').reset();
        }
        
        document.getElementById('customRuleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const port = parseInt(document.getElementById('customPort').value);
            const protocol = document.getElementById('customProtocol').value;
            const action = document.getElementById('customAction').value;
            const description = document.getElementById('customDescription').value;
            
            try {
                const endpoint = action === 'allow' ? '/api/ports/open' : '/api/ports/block';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({port, protocol, description})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('ËßÑÂàôÊ∑ªÂä†ÊàêÂäüÔºÅ');
                    closeCustomModal();
                    loadCustomRules();
                } else {
                    alert('Ê∑ªÂä†Â§±Ë¥•Ôºö' + data.message);
                }
            } catch (error) {
                alert('Ê∑ªÂä†Â§±Ë¥•Ôºö' + error.message);
            }
        });
        
        async function deleteRule(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËßÑÂàôÂêóÔºü')) return;
            
            try {
                const response = await fetch(`/api/ports/${id}`, {method: 'DELETE'});
                const data = await response.json();
                
                if (data.success) {
                    alert('ËßÑÂàôÂ∑≤Âà†Èô§ÔºÅ');
                    loadCustomRules();
                } else {
                    alert('Âà†Èô§Â§±Ë¥•Ôºö' + data.message);
                }
            } catch (error) {
                alert('Âà†Èô§Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // Á´ØÂè£Êâ´ÊèèÊ£ÄÊµã
        async function loadScanDetection() {
            // ËøôÈáåÂèØ‰ª•‰ªéÂêéÁ´ØAPIËé∑ÂèñÁ´ØÂè£Êâ´ÊèèÊ£ÄÊµãÊï∞ÊçÆ
            document.getElementById('scanDetectionBody').innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">
                        ÊöÇÊó†Ê£ÄÊµãÂà∞Á´ØÂè£Êâ´ÊèèË°å‰∏∫
                    </td>
                </tr>
            `;
        }
        
        // Êìç‰ΩúÊó•Âøó
        async function loadLogs() {
            // ËøôÈáåÂèØ‰ª•‰ªéÂÆ°ËÆ°Êó•ÂøóAPIËé∑ÂèñÊï∞ÊçÆ
            document.getElementById('logsBody').innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">
                        ÊöÇÊó†Êìç‰ΩúÊó•Âøó
                    </td>
                </tr>
            `;
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°
        function updateStats() {
            document.getElementById('totalPorts').textContent = wellKnownPorts.length;
            document.getElementById('openPorts').textContent = commonPorts.filter(p => p.action === 'allow').length;
            document.getElementById('blockedPorts').textContent = commonPorts.filter(p => p.action === 'deny').length;
            document.getElementById('customRules').textContent = customRules.length;
        }
        
        // ËøáÊª§Á´ØÂè£
        function filterPorts() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.port-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(search) ? 'block' : 'none';
            });
        }
        
        // ÊâπÈáèÊìç‰Ωú
        function batchOpen() {
            alert('ÊâπÈáèÂºÄÊîæÂäüËÉΩÂºÄÂèë‰∏≠...');
        }
        
        function batchBlock() {
            alert('ÊâπÈáèÈòªÊ≠¢ÂäüËÉΩÂºÄÂèë‰∏≠...');
        }
        
        function refreshScanData() {
            loadScanDetection();
        }
        
        function exportLogs() {
            alert('ÂØºÂá∫ÂäüËÉΩÂºÄÂèë‰∏≠...');
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        loadCommonPorts();
        setInterval(updateStats, 30000); // ÊØè30ÁßíÊõ¥Êñ∞ÁªüËÆ°
    </script>
</body>
</html>

