<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§„åˆ™ç®¡ç† - Nginxé˜²ç«å¢™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .rule-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .rule-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .rule-info {
            flex: 1;
        }
        
        .rule-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .rule-desc {
            color: #718096;
            margin-bottom: 10px;
        }
        
        .rule-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #a0aec0;
        }
        
        .rule-actions {
            display: flex;
            gap: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .badge-info {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            font-family: monospace;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input {
            width: auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ è§„åˆ™ç®¡ç†ä¸­å¿ƒ</h1>
            <div>
                <a href="/" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
                <a href="/api/auth/logout" class="btn btn-danger">é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalRules">0</div>
                <div class="stat-label">æ€»è§„åˆ™æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enabledRules">0</div>
                <div class="stat-label">å·²å¯ç”¨è§„åˆ™</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="customRules">0</div>
                <div class="stat-label">è‡ªå®šä¹‰è§„åˆ™</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('threat')">å¨èƒæ£€æµ‹è§„åˆ™</div>
            <div class="tab" onclick="switchTab('custom')">è‡ªå®šä¹‰è§„åˆ™</div>
            <div class="tab" onclick="switchTab('scoring')">è¯„åˆ†é…ç½®</div>
        </div>
        
        <!-- å¨èƒæ£€æµ‹è§„åˆ™ -->
        <div id="threat-tab" class="tab-content active">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>å¨èƒæ£€æµ‹è§„åˆ™</h2>
                    <button class="btn btn-primary" onclick="showAddThreatRule()">+ æ·»åŠ è§„åˆ™</button>
                </div>
                <div id="threatRulesList"></div>
            </div>
        </div>
        
        <!-- è‡ªå®šä¹‰è§„åˆ™ -->
        <div id="custom-tab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>è‡ªå®šä¹‰è§„åˆ™</h2>
                    <button class="btn btn-primary" onclick="showAddCustomRule()">+ æ·»åŠ è‡ªå®šä¹‰è§„åˆ™</button>
                </div>
                <div id="customRulesList"></div>
            </div>
        </div>
        
        <!-- è¯„åˆ†é…ç½® -->
        <div id="scoring-tab" class="tab-content">
            <div class="card">
                <h2>è¯„åˆ†ç³»ç»Ÿé…ç½®</h2>
                <p style="color: #718096; margin: 10px 0 20px 0;">é…ç½®ä¸åŒå¨èƒç±»å‹çš„åŸºç¡€åˆ†æ•°å’Œå°ç¦é˜ˆå€¼</p>
                <div id="scoringConfig"></div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘å¨èƒè§„åˆ™æ¨¡æ€æ¡† -->
    <div id="threatRuleModal" class="modal">
        <div class="modal-content">
            <h2 id="threatModalTitle">æ·»åŠ å¨èƒæ£€æµ‹è§„åˆ™</h2>
            <form id="threatRuleForm">
                <input type="hidden" id="threatRuleId">
                
                <div class="form-group">
                    <label>è§„åˆ™åˆ†ç±»</label>
                    <select id="threatCategory" required>
                        <option value="sql_injection">SQLæ³¨å…¥</option>
                        <option value="xss_attack">XSSæ”»å‡»</option>
                        <option value="rate_limit">é¢‘ç‡é™åˆ¶</option>
                        <option value="scan_detection">æ‰«ææ£€æµ‹</option>
                        <option value="sensitive_path">æ•æ„Ÿè·¯å¾„</option>
                        <option value="bad_user_agent">æ¶æ„User-Agent</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>è§„åˆ™åç§°</label>
                    <input type="text" id="threatName" required placeholder="å¦‚ï¼šSQLæ³¨å…¥æ£€æµ‹">
                </div>
                
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="threatDescription" placeholder="è§„åˆ™æè¿°..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>æ£€æµ‹æ¨¡å¼ (JSONæ•°ç»„ï¼Œå¯é€‰)</label>
                    <textarea id="threatPatterns" placeholder='["pattern1", "pattern2"]'></textarea>
                </div>
                
                <div class="form-group">
                    <label>è§„åˆ™å‚æ•° (JSONæ ¼å¼ï¼Œå¯é€‰)</label>
                    <textarea id="threatParameters" placeholder='{"window_seconds": 60, "max_requests": 100}'></textarea>
                </div>
                
                <div class="form-group">
                    <label>å¨èƒåˆ†æ•°</label>
                    <input type="number" id="threatScore" value="30" min="0" required>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="threatEnabled" checked>
                    <label>å¯ç”¨æ­¤è§„åˆ™</label>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeThreatModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘è‡ªå®šä¹‰è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="customRuleModal" class="modal">
        <div class="modal-content">
            <h2 id="customModalTitle">æ·»åŠ è‡ªå®šä¹‰è§„åˆ™</h2>
            <form id="customRuleForm">
                <input type="hidden" id="customRuleId">
                
                <div class="form-group">
                    <label>è§„åˆ™åç§°</label>
                    <input type="text" id="customName" required placeholder="å¦‚ï¼šæ·±å¤œå¼‚å¸¸è®¿é—®">
                </div>
                
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="customDescription" placeholder="è§„åˆ™æè¿°..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>è§„åˆ™ç±»å‹</label>
                    <select id="customRuleType" required>
                        <option value="pattern">æ¨¡å¼åŒ¹é…</option>
                        <option value="rate">é¢‘ç‡é™åˆ¶</option>
                        <option value="behavior">è¡Œä¸ºåˆ†æ</option>
                        <option value="time">æ—¶é—´è§„åˆ™</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>åŒ¹é…æ¡ä»¶ (JSONæ ¼å¼)</label>
                    <textarea id="customConditions" required placeholder='{"path_contains": "/admin", "time_range": "02:00-05:00"}'></textarea>
                </div>
                
                <div class="form-group">
                    <label>è¯„åˆ†</label>
                    <input type="number" id="customScore" value="30" required>
                </div>
                
                <div class="form-group">
                    <label>åŠ¨ä½œ</label>
                    <select id="customAction">
                        <option value="score">è¯„åˆ†</option>
                        <option value="ban">å°ç¦</option>
                        <option value="monitor">ç›‘æ§</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ä¼˜å…ˆçº§</label>
                    <input type="number" id="customPriority" value="100">
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="customEnabled" checked>
                    <label>å¯ç”¨æ­¤è§„åˆ™</label>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeCustomModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let currentTab = 'threat';
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            await loadThreatRules();
            await loadCustomRules();
            await loadStats();
        }
        
        // åŠ è½½ç»Ÿè®¡
        async function loadStats() {
            try {
                const [threat, custom] = await Promise.all([
                    fetch('/api/rules/threat').then(r => r.json()),
                    fetch('/api/rules/custom').then(r => r.json())
                ]);
                
                const totalRules = threat.rules.length + custom.rules.length;
                const enabledRules = threat.rules.filter(r => r.enabled).length + 
                                   custom.rules.filter(r => r.enabled).length;
                
                document.getElementById('totalRules').textContent = totalRules;
                document.getElementById('enabledRules').textContent = enabledRules;
                document.getElementById('customRules').textContent = custom.rules.length;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¨èƒæ£€æµ‹è§„åˆ™
        async function loadThreatRules() {
            try {
                const response = await fetch('/api/rules/threat');
                const data = await response.json();
                
                const container = document.getElementById('threatRulesList');
                container.innerHTML = data.rules.map(rule => `
                    <div class="rule-item">
                        <div class="rule-info">
                            <div class="rule-title">
                                ${rule.name}
                                <span class="badge ${rule.enabled ? 'badge-success' : 'badge-danger'}">
                                    ${rule.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                                </span>
                                <span class="badge badge-info">${rule.category}</span>
                            </div>
                            <div class="rule-desc">${rule.description || 'æ— æè¿°'}</div>
                            <div class="rule-meta">
                                <span>ğŸ“Š å¨èƒåˆ†æ•°: ${rule.threat_score}</span>
                                <span>ğŸ” æ¨¡å¼æ•°: ${rule.patterns ? JSON.parse(rule.patterns).length : 0}</span>
                                <span>ğŸ•’ æ›´æ–°: ${new Date(rule.updated_at).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="rule-actions">
                            <button class="btn btn-primary" onclick="editThreatRule(${rule.id})">ç¼–è¾‘</button>
                            <button class="btn ${rule.enabled ? 'btn-danger' : 'btn-success'}" 
                                    onclick="toggleThreatRule(${rule.id}, ${!rule.enabled})">
                                ${rule.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteThreatRule(${rule.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å¨èƒè§„åˆ™å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½è‡ªå®šä¹‰è§„åˆ™
        async function loadCustomRules() {
            try {
                const response = await fetch('/api/rules/custom');
                const data = await response.json();
                
                const container = document.getElementById('customRulesList');
                container.innerHTML = data.rules.map(rule => `
                    <div class="rule-item">
                        <div class="rule-info">
                            <div class="rule-title">
                                ${rule.name}
                                <span class="badge ${rule.enabled ? 'badge-success' : 'badge-danger'}">
                                    ${rule.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                                </span>
                                <span class="badge badge-info">${rule.rule_type}</span>
                            </div>
                            <div class="rule-desc">${rule.description || 'æ— æè¿°'}</div>
                            <div class="rule-meta">
                                <span>ğŸ“Š è¯„åˆ†: ${rule.score}</span>
                                <span>ğŸ¯ åŠ¨ä½œ: ${rule.action}</span>
                                <span>â­ ä¼˜å…ˆçº§: ${rule.priority}</span>
                                <span>ğŸ•’ æ›´æ–°: ${new Date(rule.updated_at).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="rule-actions">
                            <button class="btn btn-primary" onclick="editCustomRule(${rule.id})">ç¼–è¾‘</button>
                            <button class="btn ${rule.enabled ? 'btn-danger' : 'btn-success'}" 
                                    onclick="toggleCustomRule(${rule.id}, ${!rule.enabled})">
                                ${rule.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteCustomRule(${rule.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½è‡ªå®šä¹‰è§„åˆ™å¤±è´¥:', error);
            }
        }
        
        // å¨èƒè§„åˆ™ç›¸å…³å‡½æ•°
        function showAddThreatRule() {
            document.getElementById('threatModalTitle').textContent = 'æ·»åŠ å¨èƒæ£€æµ‹è§„åˆ™';
            document.getElementById('threatRuleForm').reset();
            document.getElementById('threatRuleId').value = '';
            document.getElementById('threatRuleModal').classList.add('active');
        }
        
        function closeThreatModal() {
            document.getElementById('threatRuleModal').classList.remove('active');
        }
        
        async function editThreatRule(id) {
            try {
                const response = await fetch(`/api/rules/threat/${id}`);
                const rule = await response.json();
                
                document.getElementById('threatModalTitle').textContent = 'ç¼–è¾‘å¨èƒæ£€æµ‹è§„åˆ™';
                document.getElementById('threatRuleId').value = rule.id;
                document.getElementById('threatCategory').value = rule.category;
                document.getElementById('threatName').value = rule.name;
                document.getElementById('threatDescription').value = rule.description || '';
                document.getElementById('threatPatterns').value = rule.patterns || '';
                document.getElementById('threatParameters').value = rule.parameters || '';
                document.getElementById('threatScore').value = rule.threat_score;
                document.getElementById('threatEnabled').checked = rule.enabled;
                
                document.getElementById('threatRuleModal').classList.add('active');
            } catch (error) {
                alert('åŠ è½½è§„åˆ™å¤±è´¥: ' + error.message);
            }
        }
        
        async function toggleThreatRule(id, enabled) {
            try {
                const response = await fetch(`/api/rules/threat/${id}/toggle`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled})
                });
                
                if (response.ok) {
                    await loadAllData();
                } else {
                    alert('æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        async function deleteThreatRule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/rules/threat/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    await loadAllData();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // è‡ªå®šä¹‰è§„åˆ™ç›¸å…³å‡½æ•°
        function showAddCustomRule() {
            document.getElementById('customModalTitle').textContent = 'æ·»åŠ è‡ªå®šä¹‰è§„åˆ™';
            document.getElementById('customRuleForm').reset();
            document.getElementById('customRuleId').value = '';
            document.getElementById('customRuleModal').classList.add('active');
        }
        
        function closeCustomModal() {
            document.getElementById('customRuleModal').classList.remove('active');
        }
        
        async function editCustomRule(id) {
            try {
                const response = await fetch(`/api/rules/custom/${id}`);
                const rule = await response.json();
                
                document.getElementById('customModalTitle').textContent = 'ç¼–è¾‘è‡ªå®šä¹‰è§„åˆ™';
                document.getElementById('customRuleId').value = rule.id;
                document.getElementById('customName').value = rule.name;
                document.getElementById('customDescription').value = rule.description || '';
                document.getElementById('customRuleType').value = rule.rule_type;
                document.getElementById('customConditions').value = rule.conditions;
                document.getElementById('customScore').value = rule.score;
                document.getElementById('customAction').value = rule.action;
                document.getElementById('customPriority').value = rule.priority;
                document.getElementById('customEnabled').checked = rule.enabled;
                
                document.getElementById('customRuleModal').classList.add('active');
            } catch (error) {
                alert('åŠ è½½è§„åˆ™å¤±è´¥: ' + error.message);
            }
        }
        
        async function toggleCustomRule(id, enabled) {
            try {
                const response = await fetch(`/api/rules/custom/${id}/toggle`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled})
                });
                
                if (response.ok) {
                    await loadAllData();
                } else {
                    alert('æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        async function deleteCustomRule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/rules/custom/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    await loadAllData();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // è¡¨å•æäº¤
        document.getElementById('threatRuleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('threatRuleId').value;
            const data = {
                category: document.getElementById('threatCategory').value,
                name: document.getElementById('threatName').value,
                description: document.getElementById('threatDescription').value,
                patterns: document.getElementById('threatPatterns').value,
                parameters: document.getElementById('threatParameters').value,
                threat_score: parseInt(document.getElementById('threatScore').value),
                enabled: document.getElementById('threatEnabled').checked
            };
            
            try {
                const url = id ? `/api/rules/threat/${id}` : '/api/rules/threat';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeThreatModal();
                    await loadAllData();
                } else {
                    const error = await response.json();
                    alert('ä¿å­˜å¤±è´¥: ' + error.error);
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });
        
        document.getElementById('customRuleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('customRuleId').value;
            const data = {
                name: document.getElementById('customName').value,
                description: document.getElementById('customDescription').value,
                rule_type: document.getElementById('customRuleType').value,
                conditions: document.getElementById('customConditions').value,
                score: parseInt(document.getElementById('customScore').value),
                action: document.getElementById('customAction').value,
                priority: parseInt(document.getElementById('customPriority').value),
                enabled: document.getElementById('customEnabled').checked
            };
            
            try {
                const url = id ? `/api/rules/custom/${id}` : '/api/rules/custom';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeCustomModal();
                    await loadAllData();
                } else {
                    const error = await response.json();
                    alert('ä¿å­˜å¤±è´¥: ' + error.error);
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        loadAllData();
        setInterval(loadStats, 30000); // æ¯30ç§’æ›´æ–°ç»Ÿè®¡
    </script>
</body>
</html>

