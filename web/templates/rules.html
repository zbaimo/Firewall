<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>规则管理 - Nginx防火墙</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .rule-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .rule-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .rule-info {
            flex: 1;
        }
        
        .rule-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .rule-desc {
            color: #718096;
            margin-bottom: 10px;
        }
        
        .rule-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #a0aec0;
        }
        
        .rule-actions {
            display: flex;
            gap: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .badge-info {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            font-family: monospace;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input {
            width: auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛡️ 规则管理中心</h1>
            <div>
                <a href="/" class="btn btn-secondary">返回首页</a>
                <a href="/api/auth/logout" class="btn btn-danger">退出登录</a>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalRules">0</div>
                <div class="stat-label">总规则数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enabledRules">0</div>
                <div class="stat-label">已启用规则</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="customRules">0</div>
                <div class="stat-label">自定义规则</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('threat')">威胁检测规则</div>
            <div class="tab" onclick="switchTab('custom')">自定义规则</div>
            <div class="tab" onclick="switchTab('scoring')">评分配置</div>
        </div>
        
        <!-- 威胁检测规则 -->
        <div id="threat-tab" class="tab-content active">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>威胁检测规则</h2>
                    <button class="btn btn-primary" onclick="showAddThreatRule()">+ 添加规则</button>
                </div>
                <div id="threatRulesList"></div>
            </div>
        </div>
        
        <!-- 自定义规则 -->
        <div id="custom-tab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>自定义规则</h2>
                    <button class="btn btn-primary" onclick="showAddCustomRule()">+ 添加自定义规则</button>
                </div>
                <div id="customRulesList"></div>
            </div>
        </div>
        
        <!-- 评分配置 -->
        <div id="scoring-tab" class="tab-content">
            <div class="card">
                <h2>评分系统配置</h2>
                <p style="color: #718096; margin: 10px 0 20px 0;">配置不同威胁类型的基础分数和封禁阈值</p>
                <div id="scoringConfig"></div>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑威胁规则模态框 -->
    <div id="threatRuleModal" class="modal">
        <div class="modal-content">
            <h2 id="threatModalTitle">添加威胁检测规则</h2>
            <form id="threatRuleForm">
                <input type="hidden" id="threatRuleId">
                
                <div class="form-group">
                    <label>规则分类</label>
                    <select id="threatCategory" required>
                        <option value="sql_injection">SQL注入</option>
                        <option value="xss_attack">XSS攻击</option>
                        <option value="rate_limit">频率限制</option>
                        <option value="scan_detection">扫描检测</option>
                        <option value="sensitive_path">敏感路径</option>
                        <option value="bad_user_agent">恶意User-Agent</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>规则名称</label>
                    <input type="text" id="threatName" required placeholder="如：SQL注入检测">
                </div>
                
                <div class="form-group">
                    <label>描述</label>
                    <textarea id="threatDescription" placeholder="规则描述..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>检测模式 (JSON数组，可选)</label>
                    <textarea id="threatPatterns" placeholder='["pattern1", "pattern2"]'></textarea>
                </div>
                
                <div class="form-group">
                    <label>规则参数 (JSON格式，可选)</label>
                    <textarea id="threatParameters" placeholder='{"window_seconds": 60, "max_requests": 100}'></textarea>
                </div>
                
                <div class="form-group">
                    <label>威胁分数</label>
                    <input type="number" id="threatScore" value="30" min="0" required>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="threatEnabled" checked>
                    <label>启用此规则</label>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeThreatModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 添加/编辑自定义规则模态框 -->
    <div id="customRuleModal" class="modal">
        <div class="modal-content">
            <h2 id="customModalTitle">添加自定义规则</h2>
            <form id="customRuleForm">
                <input type="hidden" id="customRuleId">
                
                <div class="form-group">
                    <label>规则名称</label>
                    <input type="text" id="customName" required placeholder="如：深夜异常访问">
                </div>
                
                <div class="form-group">
                    <label>描述</label>
                    <textarea id="customDescription" placeholder="规则描述..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>规则类型</label>
                    <select id="customRuleType" required>
                        <option value="pattern">模式匹配</option>
                        <option value="rate">频率限制</option>
                        <option value="behavior">行为分析</option>
                        <option value="time">时间规则</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>匹配条件 (JSON格式)</label>
                    <textarea id="customConditions" required placeholder='{"path_contains": "/admin", "time_range": "02:00-05:00"}'></textarea>
                </div>
                
                <div class="form-group">
                    <label>评分</label>
                    <input type="number" id="customScore" value="30" required>
                </div>
                
                <div class="form-group">
                    <label>动作</label>
                    <select id="customAction">
                        <option value="score">评分</option>
                        <option value="ban">封禁</option>
                        <option value="monitor">监控</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>优先级</label>
                    <input type="number" id="customPriority" value="100">
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="customEnabled" checked>
                    <label>启用此规则</label>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeCustomModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let currentTab = 'threat';
        
        // 切换标签页
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }
        
        // 加载所有数据
        async function loadAllData() {
            await loadThreatRules();
            await loadCustomRules();
            await loadStats();
        }
        
        // 加载统计
        async function loadStats() {
            try {
                const [threat, custom] = await Promise.all([
                    fetch('/api/rules/threat').then(r => r.json()),
                    fetch('/api/rules/custom').then(r => r.json())
                ]);
                
                const totalRules = threat.rules.length + custom.rules.length;
                const enabledRules = threat.rules.filter(r => r.enabled).length + 
                                   custom.rules.filter(r => r.enabled).length;
                
                document.getElementById('totalRules').textContent = totalRules;
                document.getElementById('enabledRules').textContent = enabledRules;
                document.getElementById('customRules').textContent = custom.rules.length;
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }
        
        // 加载威胁检测规则
        async function loadThreatRules() {
            try {
                const response = await fetch('/api/rules/threat');
                const data = await response.json();
                
                const container = document.getElementById('threatRulesList');
                container.innerHTML = data.rules.map(rule => `
                    <div class="rule-item">
                        <div class="rule-info">
                            <div class="rule-title">
                                ${rule.name}
                                <span class="badge ${rule.enabled ? 'badge-success' : 'badge-danger'}">
                                    ${rule.enabled ? '已启用' : '已禁用'}
                                </span>
                                <span class="badge badge-info">${rule.category}</span>
                            </div>
                            <div class="rule-desc">${rule.description || '无描述'}</div>
                            <div class="rule-meta">
                                <span>📊 威胁分数: ${rule.threat_score}</span>
                                <span>🔍 模式数: ${rule.patterns ? JSON.parse(rule.patterns).length : 0}</span>
                                <span>🕒 更新: ${new Date(rule.updated_at).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="rule-actions">
                            <button class="btn btn-primary" onclick="editThreatRule(${rule.id})">编辑</button>
                            <button class="btn ${rule.enabled ? 'btn-danger' : 'btn-success'}" 
                                    onclick="toggleThreatRule(${rule.id}, ${!rule.enabled})">
                                ${rule.enabled ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteThreatRule(${rule.id})">删除</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载威胁规则失败:', error);
            }
        }
        
        // 加载自定义规则
        async function loadCustomRules() {
            try {
                const response = await fetch('/api/rules/custom');
                const data = await response.json();
                
                const container = document.getElementById('customRulesList');
                container.innerHTML = data.rules.map(rule => `
                    <div class="rule-item">
                        <div class="rule-info">
                            <div class="rule-title">
                                ${rule.name}
                                <span class="badge ${rule.enabled ? 'badge-success' : 'badge-danger'}">
                                    ${rule.enabled ? '已启用' : '已禁用'}
                                </span>
                                <span class="badge badge-info">${rule.rule_type}</span>
                            </div>
                            <div class="rule-desc">${rule.description || '无描述'}</div>
                            <div class="rule-meta">
                                <span>📊 评分: ${rule.score}</span>
                                <span>🎯 动作: ${rule.action}</span>
                                <span>⭐ 优先级: ${rule.priority}</span>
                                <span>🕒 更新: ${new Date(rule.updated_at).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="rule-actions">
                            <button class="btn btn-primary" onclick="editCustomRule(${rule.id})">编辑</button>
                            <button class="btn ${rule.enabled ? 'btn-danger' : 'btn-success'}" 
                                    onclick="toggleCustomRule(${rule.id}, ${!rule.enabled})">
                                ${rule.enabled ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteCustomRule(${rule.id})">删除</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载自定义规则失败:', error);
            }
        }
        
        // 威胁规则相关函数
        function showAddThreatRule() {
            document.getElementById('threatModalTitle').textContent = '添加威胁检测规则';
            document.getElementById('threatRuleForm').reset();
            document.getElementById('threatRuleId').value = '';
            document.getElementById('threatRuleModal').classList.add('active');
        }
        
        function closeThreatModal() {
            document.getElementById('threatRuleModal').classList.remove('active');
        }
        
        async function editThreatRule(id) {
            try {
                const response = await fetch(`/api/rules/threat/${id}`);
                const rule = await response.json();
                
                document.getElementById('threatModalTitle').textContent = '编辑威胁检测规则';
                document.getElementById('threatRuleId').value = rule.id;
                document.getElementById('threatCategory').value = rule.category;
                document.getElementById('threatName').value = rule.name;
                document.getElementById('threatDescription').value = rule.description || '';
                document.getElementById('threatPatterns').value = rule.patterns || '';
                document.getElementById('threatParameters').value = rule.parameters || '';
                document.getElementById('threatScore').value = rule.threat_score;
                document.getElementById('threatEnabled').checked = rule.enabled;
                
                document.getElementById('threatRuleModal').classList.add('active');
            } catch (error) {
                alert('加载规则失败: ' + error.message);
            }
        }
        
        async function toggleThreatRule(id, enabled) {
            try {
                const response = await fetch(`/api/rules/threat/${id}/toggle`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled})
                });
                
                if (response.ok) {
                    await loadAllData();
                } else {
                    alert('操作失败');
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }
        
        async function deleteThreatRule(id) {
            if (!confirm('确定要删除这条规则吗？')) return;
            
            try {
                const response = await fetch(`/api/rules/threat/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    await loadAllData();
                } else {
                    alert('删除失败');
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }
        
        // 自定义规则相关函数
        function showAddCustomRule() {
            document.getElementById('customModalTitle').textContent = '添加自定义规则';
            document.getElementById('customRuleForm').reset();
            document.getElementById('customRuleId').value = '';
            document.getElementById('customRuleModal').classList.add('active');
        }
        
        function closeCustomModal() {
            document.getElementById('customRuleModal').classList.remove('active');
        }
        
        async function editCustomRule(id) {
            try {
                const response = await fetch(`/api/rules/custom/${id}`);
                const rule = await response.json();
                
                document.getElementById('customModalTitle').textContent = '编辑自定义规则';
                document.getElementById('customRuleId').value = rule.id;
                document.getElementById('customName').value = rule.name;
                document.getElementById('customDescription').value = rule.description || '';
                document.getElementById('customRuleType').value = rule.rule_type;
                document.getElementById('customConditions').value = rule.conditions;
                document.getElementById('customScore').value = rule.score;
                document.getElementById('customAction').value = rule.action;
                document.getElementById('customPriority').value = rule.priority;
                document.getElementById('customEnabled').checked = rule.enabled;
                
                document.getElementById('customRuleModal').classList.add('active');
            } catch (error) {
                alert('加载规则失败: ' + error.message);
            }
        }
        
        async function toggleCustomRule(id, enabled) {
            try {
                const response = await fetch(`/api/rules/custom/${id}/toggle`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled})
                });
                
                if (response.ok) {
                    await loadAllData();
                } else {
                    alert('操作失败');
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }
        
        async function deleteCustomRule(id) {
            if (!confirm('确定要删除这条规则吗？')) return;
            
            try {
                const response = await fetch(`/api/rules/custom/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    await loadAllData();
                } else {
                    alert('删除失败');
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }
        
        // 表单提交
        document.getElementById('threatRuleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('threatRuleId').value;
            const data = {
                category: document.getElementById('threatCategory').value,
                name: document.getElementById('threatName').value,
                description: document.getElementById('threatDescription').value,
                patterns: document.getElementById('threatPatterns').value,
                parameters: document.getElementById('threatParameters').value,
                threat_score: parseInt(document.getElementById('threatScore').value),
                enabled: document.getElementById('threatEnabled').checked
            };
            
            try {
                const url = id ? `/api/rules/threat/${id}` : '/api/rules/threat';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeThreatModal();
                    await loadAllData();
                } else {
                    const error = await response.json();
                    alert('保存失败: ' + error.error);
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        });
        
        document.getElementById('customRuleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('customRuleId').value;
            const data = {
                name: document.getElementById('customName').value,
                description: document.getElementById('customDescription').value,
                rule_type: document.getElementById('customRuleType').value,
                conditions: document.getElementById('customConditions').value,
                score: parseInt(document.getElementById('customScore').value),
                action: document.getElementById('customAction').value,
                priority: parseInt(document.getElementById('customPriority').value),
                enabled: document.getElementById('customEnabled').checked
            };
            
            try {
                const url = id ? `/api/rules/custom/${id}` : '/api/rules/custom';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeCustomModal();
                    await loadAllData();
                } else {
                    const error = await response.json();
                    alert('保存失败: ' + error.error);
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        });
        
        // 页面加载时初始化
        loadAllData();
        setInterval(loadStats, 30000); // 每30秒更新统计
    </script>
</body>
</html>

